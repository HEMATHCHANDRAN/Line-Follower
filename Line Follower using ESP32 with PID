#define rightSensor 34  // Right IR sensor connected to GPIO34
#define leftSensor 35   // Left IR sensor connected to GPIO35

#define motor1Pin1 18   // Motor 1 connected to GPIO18
#define motor1Pin2 19   // Motor 1 connected to GPIO19
#define motor2Pin1 21   // Motor 2 connected to GPIO21
#define motor2Pin2 22   // Motor 2 connected to GPIO22

// PID constants
float Kp = 0.5;
float Ki = 0.1;
float Kd = 0.01;

float lastError = 0;
float integral = 0;

void setup() {
  pinMode(rightSensor, INPUT);
  pinMode(leftSensor, INPUT);
  
  pinMode(motor1Pin1, OUTPUT);
  pinMode(motor1Pin2, OUTPUT);
  pinMode(motor2Pin1, OUTPUT);
  pinMode(motor2Pin2, OUTPUT);
  
  Serial.begin(115200);
}

void loop() {
  int rightValue = analogRead(rightSensor);
  int leftValue = analogRead(leftSensor);

  int error = leftValue - rightValue;

  integral += error;
  float derivative = error - lastError;
  float output = Kp * error + Ki * integral + Kd * derivative;

  lastError = error;

  if (output > 255) output = 255;
  if (output < -255) output = -255;

  if (output > 0) {
    // Turn right
    analogWrite(motor1Pin1, 255 - output);
    analogWrite(motor1Pin2, 0);
    analogWrite(motor2Pin1, 255);
    analogWrite(motor2Pin2, 0);
  } else {
    // Turn left
    analogWrite(motor1Pin1, 255);
    analogWrite(motor1Pin2, 0);
    analogWrite(motor2Pin1, 255 + output);
    analogWrite(motor2Pin2, 0);
  }

  delay(10);
}

void moveForward() {
  digitalWrite(motor1Pin1, HIGH);
  digitalWrite(motor1Pin2, LOW);
  digitalWrite(motor2Pin1, HIGH);
  digitalWrite(motor2Pin2, LOW);
}

void turnRight() {
  digitalWrite(motor1Pin1, HIGH);
  digitalWrite(motor1Pin2, LOW);
  digitalWrite(motor2Pin1, LOW);
  digitalWrite(motor2Pin2, HIGH);
}

void turnLeft() {
  digitalWrite(motor1Pin1, LOW);
  digitalWrite(motor1Pin2, HIGH);
  digitalWrite(motor2Pin1, HIGH);
  digitalWrite(motor2Pin2, LOW);
}

void stopMoving() {
  digitalWrite(motor1Pin1, LOW);
  digitalWrite(motor1Pin2, LOW);
  digitalWrite(motor2Pin1, LOW);
  digitalWrite(motor2Pin2, LOW);
}
